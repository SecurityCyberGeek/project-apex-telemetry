<dashboard version="1.1" theme="dark">
  <label>Project Apex: Mission Control (Dual Telemetry)</label>
  <description>Pre-Season Shakedown // Car: MCL40-Proto // Track: Barcelona-Catalunya</description>
  
  <!-- TIME PICKER INPUT (RESTORED) -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="global_time" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>rt-30s</earliest>
        <latest>rt</latest>
      </default>
    </input>
  </fieldset>

  <!-- ROW 1: HEADS UP DISPLAY -->
  <row>
    <panel>
      <title>Aero Stability Status (System)</title>
      <single>
        <search>
          <!-- FIXED: Handles multivalue status to prevent "Two Stable Statuses" error -->
          <query>index=* sourcetype="_json" 
| spath 
| eval status=mvindex(coalesce(status, 'event.status'), 0) 
| stats latest(status) as status 
| eval status_color=if(status=="STABLE", "OK", "CRITICAL") 
| table status</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
          <refresh>1s</refresh>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x53a051","0xdc4e41"]</option>
        <option name="rangeValues">[0]</option>
        <option name="useColors">1</option>
        <option name="showSparkline">0</option> 
        <option name="height">150</option>
      </single>
    </panel>
    
    <panel>
      <title>Live Speed (Head-to-Head)</title>
      <!-- LANDO'S GAUGE -->
      <single>
         <title>Lando (CAR_1)</title>
         <search>
          <!-- FIXED: Extracts first value -> converts to number -> rounds -->
          <query>index=* "CAR_1" 
| spath 
| eval car_id=mvindex(coalesce(car_id, 'event.car_id'), 0) 
| eval speed_kph=mvindex(coalesce(speed_kph, 'event.speed_kph'), 0) 
| search car_id="CAR_1" 
| eval speed_kph=round(tonumber(speed_kph), 0) 
| stats latest(speed_kph) as speed_kph 
| table speed_kph</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
          <refresh>1s</refresh>
        </search>
        <option name="numberPrecision">0</option>
        <option name="colorMode">none</option>
        <option name="underLabel">KPH</option>
        <option name="showSparkline">0</option>
        <option name="height">150</option>
      </single>
      
      <!-- OSCAR'S GAUGE -->
      <single>
         <title>Oscar (CAR_81)</title>
         <search>
          <query>index=* "CAR_81" 
| spath 
| eval car_id=mvindex(coalesce(car_id, 'event.car_id'), 0) 
| eval speed_kph=mvindex(coalesce(speed_kph, 'event.speed_kph'), 0) 
| search car_id="CAR_81" 
| eval speed_kph=round(tonumber(speed_kph), 0) 
| stats latest(speed_kph) as speed_kph 
| table speed_kph</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
          <refresh>1s</refresh>
        </search>
        <option name="numberPrecision">0</option>
        <option name="colorMode">none</option>
        <option name="underLabel">KPH</option>
        <option name="showSparkline">0</option>
        <option name="height">150</option>
      </single>
    </panel>

    <panel>
      <title>Current Oscillation Energy</title>
      <chart>
        <search>
          <query>index=* sourcetype="_json" 
| spath 
| eval oscillation_energy=mvindex(coalesce(oscillation_energy, 'event.oscillation_energy'), 0) 
| eval energy=tonumber(oscillation_energy) 
| stats max(energy) as energy</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
          <refresh>1s</refresh>
        </search>
        <option name="charting.chart">radialGauge</option>
        <option name="charting.chart.style">minimal</option>
        <option name="charting.chart.rangeValues">[0,50,100,500]</option>
        <option name="charting.gaugeColors">["0x53a051","0xFF8000","0xdc4e41"]</option>
        <option name="height">180</option>
      </chart>
    </panel>
  </row>

  <!-- ROW 2: DEEP DIVE ANALYTICS -->
  <row>
    <panel>
      <title>Porpoising Detector (Energy > 100J = Violation)</title>
      <chart>
        <search>
          <!-- FIXED: Filters for CAR_1 and cleans data for charting -->
          <query>index=* "CAR_1" 
| spath 
| eval car_id=mvindex(coalesce(car_id, 'event.car_id'), 0) 
| eval oscillation_energy=mvindex(coalesce(oscillation_energy, 'event.oscillation_energy'), 0) 
| search car_id="CAR_1" 
| eval oscillation_energy=tonumber(oscillation_energy) 
| timechart span=250ms max(oscillation_energy) as "Vertical Energy" 
| eval Threshold=100</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
          <refresh>1s</refresh>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.overlayFields">Threshold</option>
        <option name="charting.axisTitleY.text">Energy (J)</option>
        <option name="charting.axisTitleX.text">Time (Live)</option>
        <option name="charting.seriesColors">["0xFF8000", "0xFF0000"]</option> 
        <option name="charting.legend.placement">top</option>
        <option name="height">300</option>
      </chart>
    </panel>
  </row>

  <!-- ROW 3: DEBUGGER / LOGS -->
  <row>
    <panel>
      <title>Live Event Stream (All Data)</title>
      <table>
        <search>
          <!-- FIXED: Handles multivalue fields to ensure table columns populate -->
          <query>index=* sourcetype="_json" 
| spath 
| eval car_id=mvindex(coalesce(car_id, 'event.car_id'), 0) 
| eval speed_kph=mvindex(coalesce(speed_kph, 'event.speed_kph'), 0) 
| eval oscillation_energy=mvindex(coalesce(oscillation_energy, 'event.oscillation_energy'), 0) 
| eval message=mvindex(coalesce(message, 'event.message'), 0) 
| eval speed_kph=round(tonumber(speed_kph), 0) 
| eval oscillation_energy=round(tonumber(oscillation_energy), 2) 
| table _time, source, car_id, speed_kph, oscillation_energy, message 
| rename oscillation_energy as "Energy (J)", speed_kph as "Speed (KPH)" 
| sort -_time</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <format type="color" field="Energy (J)">
          <colorPalette type="minMidMax" maxColor="#DC4E41" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
      </table>
    </panel>
  </row>
</dashboard>
